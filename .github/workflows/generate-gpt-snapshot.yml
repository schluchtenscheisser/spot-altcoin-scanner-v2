name: Generate GPT Snapshot

on:
  push:
    branches:
      - main
    paths:
      - 'scanner/**/*.py'
      - 'docs/**/*.md'
      - 'config/**/*'
  workflow_dispatch:
    inputs:
      snapshot_type:
        description: 'Snapshot type'
        required: false
        default: 'automatic'
        type: choice
        options:
          - automatic
          - manual
          - milestone

permissions:
  contents: write

jobs:
  generate-snapshot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Get recent changes
        id: changes
        run: |
          # Get last 5 commits
          COMMITS=$(git log -5 --pretty=format:"- %s (%h)" --no-merges)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get changed files in last commit
          FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | head -20)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Generate Snapshot
        run: |
          python3 << 'EOF'
          import os
          from pathlib import Path
          from datetime import datetime
          
          # Get inputs
          commits = """${{ steps.changes.outputs.commits }}"""
          changed_files = """${{ steps.changes.outputs.files }}"""
          snapshot_type = "${{ github.event.inputs.snapshot_type || 'automatic' }}"
          
          # Generate snapshot
          snapshot_date = datetime.utcnow().strftime('%Y-%m-%d')
          snapshot_time = datetime.utcnow().strftime('%H:%M UTC')
          
          snapshot = f"""# GPT Snapshot - {snapshot_date}

## Status
**Type:** {snapshot_type.capitalize()}  
**Generated:** {snapshot_time}  
**Trigger:** {'Manual workflow dispatch' if snapshot_type == 'manual' else 'Automatic (push to main)'}

---

## Recent Changes

### Last 5 Commits
{commits}

### Changed Files
```
{changed_files}
```

---

## Current Project State

### Development Status
- **Phase:** {'7 (Backtesting)' if 'backtest' in changed_files.lower() else '6 Complete (MVP)'}
- **Code Map:** Up to date
- **Documentation:** Up to date

### Key Metrics
- Universe: 1837 MEXC USDT pairs
- Mapping Success: 88.4% (1624/1837)
- Pipeline Steps: 10
- Scoring Modules: 3 (Reversal, Breakout, Pullback)

---

## Notable Changes This Session

{"### Code Changes" if any('.py' in f for f in changed_files.split('\\n')) else ""}
{chr(10).join(['- ' + f for f in changed_files.split('\\n') if '.py' in f])}

{"### Documentation Changes" if any('.md' in f for f in changed_files.split('\\n')) else ""}
{chr(10).join(['- ' + f for f in changed_files.split('\\n') if '.md' in f])}

{"### Configuration Changes" if any('config' in f for f in changed_files.split('\\n')) else ""}
{chr(10).join(['- ' + f for f in changed_files.split('\\n') if 'config' in f])}

---

## Open Tasks

- [ ] Review changes in latest commit
- [ ] Run scanner to validate changes: `python -m scanner.main --mode fast`
- [ ] Check logs for any issues: `cat logs/scanner_$(date +%Y-%m-%d).log`
- [ ] Update documentation if needed

---

## For Next GPT Session

### Context to Remember
1. **Last Changes:** See commits above
2. **Current Focus:** {'Backtesting implementation' if 'backtest' in changed_files.lower() else 'MVP maintenance and monitoring'}
3. **Code Map Location:** `docs/code_map.md` (auto-updated)
4. **Specifications:** `docs/spec.md` (authoritative)

### Before Making Changes
1. Read `docs/code_map.md` to understand current structure
2. Read `docs/dev_guide.md` for development workflow
3. Check latest snapshot (this file) for recent changes
4. Review `docs/spec.md` for design constraints

### Quick Commands
```bash
# Run scanner
python -m scanner.main --mode fast

# View latest report
cat reports/$(date +%Y-%m-%d).md

# Check logs
tail -50 logs/scanner_$(date +%Y-%m-%d).log

# Manual trigger workflows
gh workflow run "Update Code Map"
gh workflow run "Generate GPT Snapshot"
```

---

## Notes

- **Automatic snapshots** are generated on every push to main that changes Python files or docs
- **Manual snapshots** can be triggered via GitHub Actions UI
- **Milestone snapshots** should be created manually before major releases
- All snapshots are stored in `snapshots/gpt/`

---

## End of Snapshot

**Next Review:** Before next development session  
**Status:** {'âœ… Stable' if snapshot_type == 'automatic' else 'ðŸ”§ In Development'}
"""
          
          # Save snapshot
          snapshot_dir = Path('snapshots/gpt')
          snapshot_dir.mkdir(parents=True, exist_ok=True)
          
          snapshot_file = snapshot_dir / f'gpt_snapshot_{snapshot_date}.md'
          
          with open(snapshot_file, 'w', encoding='utf-8') as f:
              f.write(snapshot)
          
          print(f"âœ“ Snapshot created: {snapshot_file}")
          
          EOF
      
      - name: Commit snapshot
        run: |
          SNAPSHOT_DATE=$(date +%Y-%m-%d)
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add snapshots/gpt/gpt_snapshot_${SNAPSHOT_DATE}.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "snapshots: add GPT snapshot for ${SNAPSHOT_DATE} [skip ci]"
            git push
            echo "âœ“ Snapshot committed and pushed"
          fi
      
      - name: Summary
        run: |
          SNAPSHOT_DATE=$(date +%Y-%m-%d)
          echo "âœ“ GPT Snapshot generated: snapshots/gpt/gpt_snapshot_${SNAPSHOT_DATE}.md"
          echo ""
          echo "ðŸ“‹ Snapshot includes:"
          echo "  - Recent commits (last 5)"
          echo "  - Changed files"
          echo "  - Current project state"
          echo "  - Quick commands for next session"
