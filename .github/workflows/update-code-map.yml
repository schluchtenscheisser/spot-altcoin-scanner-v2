name: Update Code Map

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'scanner/**/*.py'
      - 'tests/**/*.py'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-code-map:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Generate Code Map Update
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import ast
          from pathlib import Path
          from datetime import datetime
          
          def analyze_module(filepath):
              """Analyze a Python module and extract structure."""
              with open(filepath, 'r', encoding='utf-8') as f:
                  try:
                      tree = ast.parse(f.read())
                  except:
                      return None
              
              classes = []
              functions = []
              
              for node in ast.walk(tree):
                  if isinstance(node, ast.ClassDef):
                      methods = [m.name for m in node.body if isinstance(m, ast.FunctionDef)]
                      classes.append({'name': node.name, 'methods': methods})
                  elif isinstance(node, ast.FunctionDef) and node.col_offset == 0:
                      functions.append(node.name)
              
              return {'classes': classes, 'functions': functions}
          
          def scan_package(package_path):
              """Scan a package and return structure."""
              modules = {}
              base_path = Path(package_path).resolve()
              
              for py_file in base_path.rglob('*.py'):
                  rel_path = str(py_file.relative_to(Path.cwd()))
                  result = analyze_module(py_file)
                  if result:
                      modules[rel_path] = result
              
              return modules
          
          def generate_code_map_update():
              """Generate code map update section."""
              scanner_modules = scan_package('scanner')
              
              lines = []
              lines.append("# Code Map - Auto-Generated Section")
              lines.append("")
              lines.append(f"**Last Auto-Update:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}")
              lines.append("")
              lines.append("## Module Summary")
              lines.append("")
              
              total_classes = sum(len(m['classes']) for m in scanner_modules.values())
              total_functions = sum(len(m['functions']) for m in scanner_modules.values())
              
              lines.append(f"- **Total Modules:** {len(scanner_modules)}")
              lines.append(f"- **Total Classes:** {total_classes}")
              lines.append(f"- **Total Functions:** {total_functions}")
              lines.append("")
              lines.append("## Quick Reference")
              lines.append("")
              
              lines.append("### Classes")
              for module_path, data in sorted(scanner_modules.items()):
                  if data['classes']:
                      for cls in data['classes']:
                          lines.append(f"- **{cls['name']}** (`{module_path}`)")
                          if cls['methods']:
                              method_count = len(cls['methods'])
                              lines.append(f"  - {method_count} methods")
              
              lines.append("")
              return '\n'.join(lines)
          
          update_section = generate_code_map_update()
          
          code_map_path = Path('docs/code_map.md')
          if code_map_path.exists():
              with open(code_map_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              start_marker = '# Code Map - Auto-Generated Section'
              if start_marker in content:
                  parts = content.split(start_marker)
                  if len(parts) == 2:
                      end_idx = parts[1].find('\n## ', 100)
                      if end_idx != -1:
                          new_content = parts[0] + update_section + parts[1][end_idx:]
                      else:
                          new_content = parts[0] + update_section
                  else:
                      new_content = content + '\n\n---\n\n' + update_section
              else:
                  new_content = content + '\n\n---\n\n' + update_section
              
              with open(code_map_path, 'w', encoding='utf-8') as f:
                  f.write(new_content)
              
              print("✓ Code Map updated")
          else:
              print("✗ Code Map not found")
              exit(1)
          PYTHON_SCRIPT
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet docs/code_map.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/code_map.md
          git commit -m "docs: auto-update code map [skip ci]"
          git push
